<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>stimgate • stimgate</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="stimgate"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">stimgate</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.1-1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/stimgate.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SATVILab/stimgate" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>stimgate</h1>
      <small class="dont-index">Source: <a href="https://github.com/SATVILab/stimgate/blob/master/.github/copilot-instructions.md" class="external-link"><code>.github/copilot-instructions.md</code></a></small>
    </div>

<div id="stimgate" class="section level1">

<p>This is an R package for flow cytometry analysis, intended for eventual submission to BioConductor. The package identifies cells that have possibly responded to stimulation by comparing the unstimulated and stimulated tubes from the same sample using outlier-based gating methods.</p>
<div class="section level2">
<h2 id="package-overview">Package Overview<a class="anchor" aria-label="anchor" href="#package-overview"></a></h2>
<p><code>stimgate</code> applies statistical methods to flow cytometry data from the <code>flowCore</code> and <code>flowWorkspace</code> ecosystem to identify stimulation-specific cell responses. The package is particularly useful for analyzing immune cell activation assays where stimulated and unstimulated conditions are compared.</p>
</div>
<div class="section level2">
<h2 id="code-standards">Code standards<a class="anchor" aria-label="anchor" href="#code-standards"></a></h2>
<div class="section level3">
<h3 id="required-before-each-commit">Required before each commit<a class="anchor" aria-label="anchor" href="#required-before-each-commit"></a></h3>
<ul><li>Run <code>devtools::test()</code> to ensure all tests pass</li>
<li>Run <code>devtools::document()</code> to update documentation</li>
<li>Run <code>styler::style_pkg()</code> to ensure consistent code formatting</li>
<li>Run <code>lintr::lint_package()</code> to check for linting violations</li>
</ul></div>
<div class="section level3">
<h3 id="development-flow">Development flow<a class="anchor" aria-label="anchor" href="#development-flow"></a></h3>
<ul><li>Build and reload: Use <code>devtools::load_all()</code> to reload the package in your R session</li>
<li>Test: Run <code>devtools::test()</code> to execute all unit tests</li>
<li>Documentation: Use <code>devtools::document()</code> to update package documentation</li>
<li>Coverage: Run <code>covr::report()</code> to check test coverage</li>
<li>Full check: Run <code>devtools::check()</code> to perform a comprehensive package check</li>
</ul></div>
<div class="section level3">
<h3 id="environment-setup">Environment setup<a class="anchor" aria-label="anchor" href="#environment-setup"></a></h3>
<p>This package uses <code>renv</code> for dependency management: - The <code>.Rprofile</code> file automatically activates <code>renv</code> when you start R in the project directory - Always ensure your working directory is the project root (containing <code>DESCRIPTION</code>) when running R code - Dependencies are locked in <code>renv.lock</code> and managed through <code>renv::restore()</code> - If dependencies are missing, run <code>renv::restore()</code> to install them</p>
</div>
<div class="section level3">
<h3 id="test-data-files">Test data files<a class="anchor" aria-label="anchor" href="#test-data-files"></a></h3>
<ul><li>Test data files (<code>.rds</code> files in <code>tests/testthat/</code>) may need to be regenerated when major package dependencies are updated, especially when upgrading to new major versions of packages like <code>ggplot2</code>
</li>
<li>If tests fail with objects behaving unexpectedly after a dependency upgrade, check if the test data was created with an older version and needs regeneration</li>
<li>Regenerate test data files using the current package versions to ensure compatibility</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="repository-structure">Repository structure<a class="anchor" aria-label="anchor" href="#repository-structure"></a></h2>
<ul><li>
<code>R/</code>: Core R source code
<ul><li>
<code>cp_cluster-helper.R</code>: Helper functions for getting thresholds lower by grouping thresholds from like distributions</li>
<li>
<code>cp_cluster.R</code>: Gets thresholds lower by grouping thresholds from like distributions</li>
<li>
<code>cp_uns_loc.R</code>: Gets thresholds by comparing the stim and unstim distributions to identify the point at which cells start appearing to have responded with some probability</li>
<li>
<code>cp-sub.R</code>: Auxiliary functions for getting clusters</li>
<li>
<code>cp_cut_pos_gates-helper.R</code>: Helper functions for getting more aggressive gates when applied to just the cytokine-positive cells.</li>
<li>
<code>cyt_pos_gates.R</code>: Functions for getting more aggressive gates when applied to just the cytokine-positive cells.</li>
<li>
<code>debug.R</code>: Debugging utilities and specifies global variables</li>
<li>
<code>ex.R</code>: Extract expression matrices from GatingSets</li>
<li>
<code>fcs_write.R</code>: Write FCS files of just cytokine-positive cells</li>
<li>
<code>gate_batch-helper.R</code>: Helper functions for gating batches of samples</li>
<li>
<code>gate_batch.R</code>: Gate batches of samples</li>
<li>
<code>gate_marker-helper.R</code>: Helper functions for gating markers (within each marker, we gate all the batches)</li>
<li>
<code>gate_marker.R</code>: Gate markers (within each marker, we gate all the batches)</li>
<li>
<code>gate.R</code>: Main entry point for gating</li>
<li>
<code>gates.R</code>: Extract the identified gates (thresholds)</li>
<li>
<code>helper-data.R</code>: Creates example GatingSet for examples and testing</li>
<li>
<code>ind_batch.R</code>: Get the list of indices grouped by batch</li>
<li>
<code>marker_list.R</code>: Get full parameters used for each marker</li>
<li>
<code>plot_gate.R</code>: Plot the identified gates</li>
<li>
<code>pos_ind.R</code>: Identify the indices of the cytokine-positive cells</li>
<li>
<code>stats-helper-overall.R</code>: Helper functions for overall statistics</li>
<li>
<code>stats-helper.R</code>: Helper functions for statistics</li>
<li>
<code>stats.R</code>: Get statistics for the identified gates</li>
</ul></li>
<li>
<code>_reference/</code>:
<ul><li>Reference material for the package, which at this stage is just old scripts that I didn’t want to completely delete at the time.</li>
</ul></li>
<li>
<code>.github/</code>: GitHub associated files</li>
<li>
<code>data-raw/</code>: Raw data files used for testing and examples</li>
<li>
<code>man/</code>: Automatically generated documentation files</li>
<li>
<code>renv/</code>: R package environment management files</li>
<li>
<code>tests/</code>: Unit tests for the package</li>
<li>
<code>_dependencies.R</code>: Explicitly listed dependencies for <code>renv</code> to pick up via <code>implicit</code> dependencies</li>
<li>
<code>.gitignore</code>: Git ignore file to exclude unnecessary files from version control</li>
<li>
<code>.Rbuildignore</code>: R build ignore file to exclude unnecessary files from package builds</li>
<li>
<code>DESCRIPTION</code>: Package metadata file</li>
<li>
<code>LICENSE</code>: License file for the package</li>
<li>
<code>LICENSE.md</code>: License file in Markdown format</li>
<li>
<code>README.md</code>: Package overview and usage documentation</li>
<li>
<code>renv.lock</code>: Lock file for the <code>renv</code> package management system, capturing the state of the R package environment</li>
</ul></div>
<div class="section level2">
<h2 id="key-guidelines">Key Guidelines<a class="anchor" aria-label="anchor" href="#key-guidelines"></a></h2>
<ol style="list-style-type: decimal"><li>Begin each internal function with a <code>.</code>
</li>
<li>Use <code>.debug</code> as the parameter name for debugging flags in internal functions</li>
<li>Use <code>.debug_msg()</code> for debug messages, which takes a boolean, a message and an optional value</li>
<li>Add unit tests using <code>testthat</code> for all new functionality</li>
<li>Validate inputs and provide meaningful error messages</li>
<li>Explicitly refer to all packages used, rather than using <code>@import</code> or <code>@importFrom</code>, with the exception of <code>ggplot2</code> functions and the <code><a href="https://rdrr.io/pkg/Biobase/man/exprs.html" class="external-link">flowCore::exprs</a></code> function</li>
<li>Use <code>@export</code> for functions that should be available to users</li>
<li>When running code from the project, you must always have as your working directory the root of the project, i.e. the directory containing the <code>DESCRIPTION</code> file. This is especially important when the project uses <code>renv</code>, as otherwise the <code>.Rprofile</code> will not be sourced and the package environment will not be set up correctly</li>
<li>Never update <code>.Rd</code> files manually; use <code>devtools::document()</code> to regenerate them</li>
<li>Documentation in <code>.R</code> files for parameters must always have the format <code>@param param_name &lt;type_of_input&gt; &lt;info&gt;</code>
</li>
</ol><ul><li>For example, <code>@param path_project character Path to project.</code>
</li>
<li>Of course, the information can be longer, and where there are multiple options, it can be mentioned:
<ul><li>For example, <code>logical or character</code>, or <code>"always", "never" or "automatic"</code>
</li>
</ul></li>
<li>If there is a default specified, it should be stated at the end in the documentation of that parameter, e.g. <code>Default is "automatic".</code>
</li>
<li>Where longer parameter descriptions are required, usually you should describe overall what the parameter is for, and then list the options with a short description of each</li>
<li>If there are really nitty-gritty details, then you can use <code>@details</code> to provide more information and refer to it in the parameter description</li>
</ul><ol start="11" style="list-style-type: decimal"><li>Always make sure there is no unnecessary trailing whitespace, including for blank lines</li>
<li>Always make sure that any edited files have a final newline at the end of the file</li>
<li>Tests written should not simply test whether it errors out correctly, but should also test that the output is as expected</li>
<li>Never use <code>return</code> for the last line of a function, but only when you want to return early from a function</li>
<li>For testing, never add source commands at the top to source files in the <code>R</code> folder, as these are automatically sourced (effectively) by the <code>testthat</code> package</li>
<li>The tests need to pass on Mac, Windows and Ubuntu, so be aware of that (e.g. file path availability and specification (forward or backward slashes, root directories, etc.), case sensitivity, etc.). You do not run the tests on all three platforms, but you should think about them passing on all three platforms</li>
<li>Tests should verify observable behavior and outputs, not internal implementation details. Avoid testing for the existence of internal functions or variables (those starting with <code>.</code>). Focus on testing that functions produce the correct output, handle errors appropriately, and have the expected side effects</li>
<li>Always update this copilot-instructions.md file when you identify new coding patterns, guidelines, or best practices during issue resolution. This ensures future agents benefit from your learnings and the instructions stay current with the evolving codebase</li>
<li>
<strong>pkgdown website maintenance</strong>: Whenever functions are added, removed, or have their export status changed (via <code>@export</code>), update the <code>_pkgdown.yml</code> file to ensure the reference section accurately reflects all exported functions. The <code>_pkgdown.yml</code> file organizes functions into logical categories for the package website. After making changes, verify the pkgdown configuration is valid by running <code><a href="https://pkgdown.r-lib.org/reference/check_pkgdown.html" class="external-link">pkgdown::check_pkgdown()</a></code> if pkgdown is available</li>
</ol></div>
<div class="section level2">
<h2 id="testing-best-practices">Testing Best Practices<a class="anchor" aria-label="anchor" href="#testing-best-practices"></a></h2>
<p>When writing tests with <code>testthat</code>, follow these important practices:</p>
<ol style="list-style-type: decimal"><li><p><strong>Avoid library() calls in test files</strong>: Never use <code><a href="https://testthat.r-lib.org" class="external-link">library(testthat)</a></code> or similar calls at the top of test files. The testthat package is automatically loaded when tests are run.</p></li>
<li>
<p><strong>Keep tests independent</strong>: Each test should be self-contained and not rely on global state created outside of test blocks. If you need setup data:</p>
<ul><li>Create it within each test that needs it, OR</li>
<li>Use shared setup only when all tests in the file require it, AND</li>
<li>Ensure cleanup happens within the test or use <code><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">withr::defer()</a></code> for automatic cleanup</li>
</ul></li>
<li><p><strong>Variable scope in tests</strong>: When a test creates its own test data and variables (like <code>example_data</code>, <code>gs</code>, <code>path_project_2</code>), always use those local variables throughout that test. Never mix local and global variables from different scopes.</p></li>
<li>
<p><strong>Avoid code outside test blocks</strong>: Do not place cleanup code (like <code><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink()</a></code>) or other operations outside of <code>test_that()</code> blocks. Such code:</p>
<ul><li>Executes in an unpredictable order relative to tests</li>
<li>Can interfere with tests that run after it</li>
<li>Makes the test file harder to understand and maintain</li>
<li>May cause race conditions in parallel test execution</li>
</ul></li>
<li>
<p><strong>Cleanup within tests</strong>: Each test should clean up its own temporary files and directories:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"example test"</span>, <span class="op">{</span></span>
<span>  <span class="va">temp_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"test_output"</span><span class="op">)</span></span>
<span>  <span class="co"># ... test code ...</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">temp_dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Shared test fixtures</strong>: If multiple tests need the same setup data:</p>
<ul><li>Either create the data in each test (preferred for independence)</li>
<li>OR create it once at the top of the file, but document that all tests depend on it</li>
<li>Never delete shared fixtures until the very end of the file (if at all)</li>
</ul></li>
<li>
<p><strong>Test file structure</strong>: A well-structured test file should have:</p>
<ul><li>Optional shared setup code at the top (clearly documented)</li>
<li>All test cases in <code>test_that()</code> blocks</li>
<li>Each test responsible for its own cleanup</li>
<li>Optional final cleanup at the very end (only for shared resources)</li>
</ul></li>
</ol></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/miguelrodo" class="external-link">Miguel Rodo</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

