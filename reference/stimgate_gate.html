<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Identify cytokine-positive cells through automated gating — stimgate_gate • stimgate</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Identify cytokine-positive cells through automated gating — stimgate_gate"><meta name="description" content="Main function for identifying cytokine-positive cells using outlier-based gating
to compare stimulated versus unstimulated samples. This function implements a
comprehensive workflow that identifies cells responding to stimulation by
detecting outliers in cytokine expression distributions. The process includes
density estimation, threshold identification, clustering-based gate refinement,
and generation of comprehensive statistics and visualizations.
The function operates by comparing cytokine expression in stimulated samples
against corresponding unstimulated controls from the same donor/batch to identify
cells that have likely responded to stimulation. It accounts for batch effects,
background cytokine production, and technical variability."><meta property="og:description" content="Main function for identifying cytokine-positive cells using outlier-based gating
to compare stimulated versus unstimulated samples. This function implements a
comprehensive workflow that identifies cells responding to stimulation by
detecting outliers in cytokine expression distributions. The process includes
density estimation, threshold identification, clustering-based gate refinement,
and generation of comprehensive statistics and visualizations.
The function operates by comparing cytokine expression in stimulated samples
against corresponding unstimulated controls from the same donor/batch to identify
cells that have likely responded to stimulation. It accounts for batch effects,
background cytokine production, and technical variability."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">stimgate</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.1-1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/stimgate.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SATVILab/stimgate" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Identify cytokine-positive cells through automated gating</h1>
      <small class="dont-index">Source: <a href="https://github.com/SATVILab/stimgate/blob/master/R/gate.R" class="external-link"><code>R/gate.R</code></a></small>
      <div class="d-none name"><code>stimgate_gate.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Main function for identifying cytokine-positive cells using outlier-based gating
to compare stimulated versus unstimulated samples. This function implements a
comprehensive workflow that identifies cells responding to stimulation by
detecting outliers in cytokine expression distributions. The process includes
density estimation, threshold identification, clustering-based gate refinement,
and generation of comprehensive statistics and visualizations.</p>
<p>The function operates by comparing cytokine expression in stimulated samples
against corresponding unstimulated controls from the same donor/batch to identify
cells that have likely responded to stimulation. It accounts for batch effects,
background cytokine production, and technical variability.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">stimgate_gate</span><span class="op">(</span></span>
<span>  <span class="va">path_project</span>,</span>
<span>  <span class="va">.data</span>,</span>
<span>  <span class="va">batch_list</span>,</span>
<span>  <span class="va">marker</span>,</span>
<span>  pop_gate <span class="op">=</span> <span class="st">"root"</span>,</span>
<span>  bias_uns <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  bias_uns_factor <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  exc_min <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cp_min <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  bw_min <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  min_cell <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  max_pos_prob_x <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  gate_quant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.75</span><span class="op">)</span>,</span>
<span>  tol_clust <span class="op">=</span> <span class="fl">1e-07</span>,</span>
<span>  gate_combn <span class="op">=</span> <span class="st">"min"</span>,</span>
<span>  marker_settings <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  calc_cyt_pos_gates <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  calc_single_pos_gates <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  debug <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-path-project">path_project<a class="anchor" aria-label="anchor" href="#arg-path-project"></a></dt>
<dd><p>character. Path to project directory where all results will be saved.
This directory will contain subdirectories for each marker with gate tables,
statistics, and plots. The directory will be created if it doesn't exist.</p></dd>


<dt id="arg--data">.data<a class="anchor" aria-label="anchor" href="#arg--data"></a></dt>
<dd><p>GatingSet. A flowWorkspace GatingSet object containing the flow cytometry
data with both stimulated and unstimulated samples. The GatingSet should have
consistent channel names across all samples and include proper sample annotations.</p></dd>


<dt id="arg-batch-list">batch_list<a class="anchor" aria-label="anchor" href="#arg-batch-list"></a></dt>
<dd><p>list. Named list where each element contains indices of samples
belonging to the same batch/donor. Names will be used for batch identification.
Example: list(donor1 = 1:10, donor2 = 11:20). Proper batching is crucial for
accurate background subtraction and gate identification.</p></dd>


<dt id="arg-marker">marker<a class="anchor" aria-label="anchor" href="#arg-marker"></a></dt>
<dd><p>list. List where each element specifies parameters for gating a
specific marker. Each element should be a list containing at minimum the channel
name (e.g., list(cut = "IL2")). Additional marker-specific parameters can
override global defaults. The marker name should match channel names in the GatingSet.</p></dd>


<dt id="arg-pop-gate">pop_gate<a class="anchor" aria-label="anchor" href="#arg-pop-gate"></a></dt>
<dd><p>character vector. Population(s) within which to perform gating.
Default is "root" to gate on all cells. Can specify other populations like
"CD3+" or "CD4+" if these gates already exist in the GatingSet.</p></dd>


<dt id="arg-bias-uns">bias_uns<a class="anchor" aria-label="anchor" href="#arg-bias-uns"></a></dt>
<dd><p>numeric. Bias adjustment for unstimulated samples to account for
background cytokine production. When NULL (default), no bias correction is applied.
Positive values shift the unstimulated distribution higher, making gates more
conservative. Typically ranges from 0.1 to 1.0 when used.</p></dd>


<dt id="arg-bias-uns-factor">bias_uns_factor<a class="anchor" aria-label="anchor" href="#arg-bias-uns-factor"></a></dt>
<dd><p>numeric. Multiplicative factor applied to bias_uns.
Default is 1. Values &gt; 1 increase the bias effect, values &lt; 1 decrease it.
This provides fine-tuning of the bias correction.</p></dd>


<dt id="arg-exc-min">exc_min<a class="anchor" aria-label="anchor" href="#arg-exc-min"></a></dt>
<dd><p>logical. Whether to exclude minimum expression values during
analysis. Default is TRUE. Minimum values often represent technical artifacts
or compensation spillover and should typically be excluded.</p></dd>


<dt id="arg-cp-min">cp_min<a class="anchor" aria-label="anchor" href="#arg-cp-min"></a></dt>
<dd><p>numeric. Minimum allowable cutpoint value. When NULL (default),
no minimum is enforced. Useful for ensuring gates don't fall below known
technical thresholds or background levels.</p></dd>


<dt id="arg-bw-min">bw_min<a class="anchor" aria-label="anchor" href="#arg-bw-min"></a></dt>
<dd><p>numeric. Minimum bandwidth for density estimation. When NULL (default),
bandwidth is estimated automatically. Smaller values create more detailed density
estimates but may be noisier. Typical range is 0.01 to 0.1 on log-transformed data.</p></dd>


<dt id="arg-min-cell">min_cell<a class="anchor" aria-label="anchor" href="#arg-min-cell"></a></dt>
<dd><p>numeric. Minimum number of cells required for reliable gating.
Default is 100. Samples with fewer cells will be skipped as they don't provide
sufficient statistical power for accurate gate identification.</p></dd>


<dt id="arg-max-pos-prob-x">max_pos_prob_x<a class="anchor" aria-label="anchor" href="#arg-max-pos-prob-x"></a></dt>
<dd><p>numeric. Maximum x-value (expression level) to consider
when calculating positive probabilities. Default is Inf (no limit). Can be used
to exclude extremely high expression values that may represent doublets or artifacts.</p></dd>


<dt id="arg-gate-quant">gate_quant<a class="anchor" aria-label="anchor" href="#arg-gate-quant"></a></dt>
<dd><p>numeric vector. Quantiles used for gate combination when multiple
gates are identified. Default is c(0.25, 0.75). The method specified in gate_combn
determines how these quantiles are used (e.g., minimum of 25th percentiles).</p></dd>


<dt id="arg-tol-clust">tol_clust<a class="anchor" aria-label="anchor" href="#arg-tol-clust"></a></dt>
<dd><p>numeric. Convergence tolerance for clustering algorithms used in
gate refinement. Default is 1e-7. Smaller values require more precise convergence
but may increase computation time.</p></dd>


<dt id="arg-gate-combn">gate_combn<a class="anchor" aria-label="anchor" href="#arg-gate-combn"></a></dt>
<dd><p>character. Method for combining multiple gate candidates.
Default is "min" to use the most conservative (lowest) gate. Other options may
include "median" or "max" depending on the desired stringency.</p></dd>


<dt id="arg-marker-settings">marker_settings<a class="anchor" aria-label="anchor" href="#arg-marker-settings"></a></dt>
<dd><p>list. Optional list of additional marker-specific settings
that override global defaults. Each element should be named with the marker name
and contain parameter overrides. Default is NULL.</p></dd>


<dt id="arg-calc-cyt-pos-gates">calc_cyt_pos_gates<a class="anchor" aria-label="anchor" href="#arg-calc-cyt-pos-gates"></a></dt>
<dd><p>logical. Whether to calculate refined cytokine-positive
gates using more sophisticated algorithms. Default is TRUE. When FALSE, only
basic gates are calculated, which may be less accurate but faster.</p></dd>


<dt id="arg-calc-single-pos-gates">calc_single_pos_gates<a class="anchor" aria-label="anchor" href="#arg-calc-single-pos-gates"></a></dt>
<dd><p>logical. Whether to calculate single-positive gates
for individual markers in addition to combination gates. Default is FALSE.
Useful for detailed analysis of individual marker responses.</p></dd>


<dt id="arg-debug">debug<a class="anchor" aria-label="anchor" href="#arg-debug"></a></dt>
<dd><p>logical. Whether to enable detailed debug output and save intermediate
results. Default is FALSE. When TRUE, additional files and verbose output are
generated, useful for troubleshooting and method development.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>character. Returns the path to the project directory where all results
have been saved. The directory structure created includes:</p><ul><li><p><code>path_project/[marker_name]/</code>: Directory for each marker containing:</p></li>
<li><p><code>gate_tbl_init.rds</code>: Initial gate table with preliminary gates</p></li>
<li><p><code>gate_tbl.rds</code>: Final refined gate table</p></li>
<li><p><code>stats/</code>: Directory containing statistics files</p></li>
<li><p><code>plots/</code>: Directory containing visualization plots (if generated)</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The function implements a multi-step workflow for identifying cytokine-positive cells:</p>
<p><strong>Step 1: Data Preparation</strong></p><ul><li><p>Validates input parameters and GatingSet structure</p></li>
<li><p>Completes marker specifications with default values</p></li>
<li><p>Organizes samples by batch for proper background subtraction</p></li>
</ul><p><strong>Step 2: Initial Gate Identification</strong></p><ul><li><p>Extracts expression data for each marker within specified populations</p></li>
<li><p>Estimates probability densities for stimulated and unstimulated samples</p></li>
<li><p>Identifies candidate cutpoints using outlier detection algorithms</p></li>
<li><p>Applies clustering to refine gate positions across batches</p></li>
</ul><p><strong>Step 3: Cytokine-Positive Gate Refinement (if calc_cyt_pos_gates = TRUE)</strong></p><ul><li><p>Applies more sophisticated algorithms to refine initial gates</p></li>
<li><p>Accounts for background cytokine production and technical variability</p></li>
<li><p>Optimizes gates to minimize false positives while maintaining sensitivity</p></li>
</ul><p><strong>Step 4: Single-Positive Gates (if calc_single_pos_gates = TRUE)</strong></p><ul><li><p>Calculates gates for individual markers independent of other markers</p></li>
<li><p>Useful for understanding single-marker responses</p></li>
</ul><p><strong>Step 5: Statistics Generation</strong></p><ul><li><p>Calculates comprehensive statistics including frequencies and combinations</p></li>
<li><p>Generates cross-tabulations of cytokine-positive populations</p></li>
<li><p>Saves results in structured format for downstream analysis</p></li>
</ul><p><strong>Important Considerations:</strong></p><ul><li><p>Ensure stimulated and unstimulated samples are properly paired by batch</p></li>
<li><p>Channel names in marker specifications must match GatingSet channels exactly</p></li>
<li><p>Sufficient cell numbers (min_cell) are crucial for reliable gate identification</p></li>
<li><p>Background bias correction (bias_uns) should be used cautiously and validated</p></li>
<li><p>Debug mode generates extensive output useful for method validation</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="stimgate_gate_get.html">stimgate_gate_get</a></code> for extracting gate information,
<code><a href="get_stats.html">get_stats</a></code> for generating statistics from results,
<code><a href="stimgate_plot.html">stimgate_plot</a></code> for visualizing identified gates,
<code><a href="stimgate_fcs_write.html">stimgate_fcs_write</a></code> for exporting cytokine-positive cells,
<code><a href="https://rdrr.io/pkg/flowWorkspace/man/GatingSet-class.html" class="external-link">GatingSet</a></code> for GatingSet documentation</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="op">{</span></span></span>
<span class="r-in"><span><span class="va">example_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="get_example_data.html">get_example_data</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">gs</span> <span class="op">&lt;-</span> <span class="fu">flowWorkspace</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/save_gs.html" class="external-link">load_gs</a></span><span class="op">(</span><span class="va">example_data</span><span class="op">$</span><span class="va">path_gs</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">path_project</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"demonstration"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Run gating</span></span></span>
<span class="r-in"><span><span class="fu">stimgate</span><span class="fu">::</span><span class="fu">stimgate_gate</span><span class="op">(</span></span></span>
<span class="r-in"><span>  .data <span class="op">=</span> <span class="va">gs</span>,</span></span>
<span class="r-in"><span>  path_project <span class="op">=</span> <span class="va">path_project</span>,</span></span>
<span class="r-in"><span>  pop_gate <span class="op">=</span> <span class="st">"root"</span>,</span></span>
<span class="r-in"><span>  batch_list <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">batch_list</span>,</span></span>
<span class="r-in"><span>  marker <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">marker</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create plots</span></span></span>
<span class="r-in"><span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="stimgate_plot.html">stimgate_plot</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  ind <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">batch_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="co"># indices in `gs` to plot</span></span></span>
<span class="r-in"><span>  .data <span class="op">=</span> <span class="va">gs</span>, <span class="co"># GatingSet</span></span></span>
<span class="r-in"><span>  path_project <span class="op">=</span> <span class="va">path_project</span>,</span></span>
<span class="r-in"><span>  marker <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">marker</span>,</span></span>
<span class="r-in"><span>  grid <span class="op">=</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Advanced usage with parameter customization</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> see ?HDCytoData and browseVignettes('HDCytoData') for documentation</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> loading from cache</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Done</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> To reload it, use 'load_gs' function</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ----</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> getting base gates</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ----</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> chnl: BC1(La139)Dd</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> getting pre-adjustment gates</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> batch 8 of 8</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> getting clustered and/or controlled gates</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> chnl: BC2(Pr141)Dd</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> getting pre-adjustment gates</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> batch 8 of 8</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> getting clustered and/or controlled gates</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ----</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> getting single+ gates</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ----</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> getting cyt combn frequencies</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> batch 8 of 8</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/miguelrodo" class="external-link">Miguel Rodo</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

